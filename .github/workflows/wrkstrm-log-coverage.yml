name: "ðŸ§® Coverage | WrkstrmLog"

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write

jobs:
  coverage:
    runs-on: ubuntu-latest
    env:
      SPM_CI_USE_LOCAL_DEPS: 'false'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Swift test with coverage
        id: test
        continue-on-error: true
        run: |
          swift test --enable-code-coverage --parallel

      - name: Generate LCOV coverage (Linux)
        id: lcov
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          BIN_DIR=$(swift build --show-bin-path)
          PROFILE=$(find .build -type f -name 'default.profdata' | head -n1 || true)
          if [[ -z "${PROFILE:-}" ]]; then
            RAW=$(find .build -type f -name '*.profraw' | paste -sd' ' - || true)
            if [[ -n "${RAW:-}" ]]; then
              echo "Merging profraw into profdata" >&2
              llvm-profdata merge -sparse ${RAW} -o .build/default.profdata
              PROFILE=.build/default.profdata
            fi
          fi
          if [[ -z "${PROFILE:-}" ]]; then
            echo "No coverage profile found; skipping LCOV generation." >&2
            exit 0
          fi
          TEST=$(find "$BIN_DIR" .build -maxdepth 3 -type f -executable \
                 \( -name '*PackageTests*' -o -name '*Tests*' \) | head -n1 || true)
          if [[ -z "${TEST:-}" ]]; then
            echo "No test binary found; skipping LCOV generation." >&2
            exit 0
          fi
          mkdir -p coverage-publish/coverage
          llvm-cov export -format=lcov -instr-profile "$PROFILE" "$TEST" \
            -ignore-filename-regex '(.*/Tests/.*|.*/\.build/.*)' > coverage-publish/coverage/lcov.info

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        if: always()
        with:
          files: ${{ steps.cov.outputs.files }}
          flags: wrkstrm-log
          name: wrkstrm-log
          slug: wrkstrm/WrkstrmLog
          fail_ci_if_error: false
          verbose: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      - name: Fail if tests failed
        if: ${{ steps.test.outcome == 'failure' }}
        run: |
          echo "Tests failed, but coverage was uploaded. Failing job as requested." >&2
          exit 1
