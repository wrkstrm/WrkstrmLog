name: "ðŸ§® Coverage | WrkstrmLog"

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write

jobs:
  coverage:
    runs-on: ubuntu-latest
    env:
      SPM_CI_USE_LOCAL_DEPS: 'false'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Swift test with coverage
        id: test
        continue-on-error: true
        run: |
          swift test --enable-code-coverage --parallel

      - name: Collect Codecov coverage JSON paths (Linux)
        id: cov
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          files=$(swift test --enable-code-coverage --show-codecov-path | tr -d '\r' | paste -sd, -)
          echo "files=$files" >> "$GITHUB_OUTPUT"

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        if: always()
        with:
          files: ${{ steps.cov.outputs.files }}
          flags: wrkstrm-log
          name: wrkstrm-log
          slug: wrkstrm/WrkstrmLog
          fail_ci_if_error: false
          verbose: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      - name: Fail if tests failed
        if: ${{ steps.test.outcome == 'failure' }}
        run: |
          echo "Tests failed, but coverage was uploaded. Failing job as requested." >&2
          exit 1
