name: "ðŸ•¸ï¸ WASM Build"

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
    tags: [ 'v*.*.*' ]

jobs:
  wasm-build:
    name: wasm32-unknown-wasi (Docker)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Print versions
        run: |
          uname -a || true
          docker --version || true

      - name: Pull SPI WASM image
        run: docker pull registry.gitlab.com/finestructure/spi-images:wasm-6.2-latest

      - name: Build WrkstrmLog for wasm32-unknown-wasi
        env:
          WORKDIR: ${{ github.workspace }}
          PKG_PATH: code/mono/apple/spm/universal/WrkstrmLog
        run: |
          set -euo pipefail
          docker run --rm \
            -v "$WORKDIR":/host \
            -w "/host/$PKG_PATH" \
            registry.gitlab.com/finestructure/spi-images:wasm-6.2-latest \
            bash -lc '
              set -euo pipefail
              echo "swift --version:"; swift --version || true
              echo "swift sdk list:"; swift sdk list || true
              if swift sdk list 2>/dev/null | grep -q wasm32-unknown-wasi; then
                swift build --swift-sdk wasm32-unknown-wasi -c release
              else
                swift build --triple wasm32-unknown-wasi -c release
              fi
            '
