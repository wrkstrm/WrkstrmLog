name: "ðŸ•¸ï¸ WASM Build | WrkstrmLog"

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
    tags: [ 'v*.*.*' ]

jobs:
  wasm-build:
    name: wasm32-unknown-wasi (Docker)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Print versions
        run: |
          uname -a || true
          docker --version || true

      - name: Pull SPI WASM image
        run: docker pull registry.gitlab.com/finestructure/spi-images:wasm-6.2-latest

      - name: Build WrkstrmLog for wasm32-unknown-wasi
        env:
          WORKDIR: ${{ github.workspace }}
          PKG_PATH: code/mono/apple/spm/universal/WrkstrmLog
        run: |
          set -euo pipefail
          docker run --rm \
            -v "$WORKDIR":/host \
            -w "/host/$PKG_PATH" \
            registry.gitlab.com/finestructure/spi-images:wasm-6.2-latest \
            bash -lc '
              set -euo pipefail
              echo "swift --version:"; swift --version || true
              echo "swift sdk list:"; swift sdk list || true
              SDK_NAME=$(swift sdk list 2>/dev/null | awk "/_wasm(\-embedded)?$/ {print \$1; exit}")
              if [ -z "${SDK_NAME:-}" ]; then
                SDK_NAME=swift-6.2-RELEASE_wasm
              fi
              echo "Using Swift SDK: $SDK_NAME"
              swift build --swift-sdk "$SDK_NAME" -c release
            '
